<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Lecteur HLS ‚Äì Reload total √† la position</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    html,body {height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center}
    #video {max-width:90vw;max-height:90vh;background:#000}
    #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      color:#fff;background:rgba(0,0,0,.8);font:16px/1.4 system-ui;opacity:0;pointer-events:none;transition:.15s}
    #loader.show{opacity:1}
  </style>
</head>
<body>
  <div id="loader">Rechargement‚Ä¶</div>
  <video id="video" controls playsinline></video>

  <script>
    const url = 'https://pulse.topstrime.online/movie/1175942/9504aw/master.m3u8';
    const video  = document.getElementById('video');
    const loader = document.getElementById('loader');

    let hls = null;
    let state = 'IDLE';              // 'IDLE' | 'RELOADING'
    let internalSeek = false;        // ignore le seek d√©clench√© par notre set currentTime
    let lastReloadTs = 0;            // anti-spam (ms)
    let lastStartPos = 0;

    const show = on => loader.classList.toggle('show', !!on);

    function hardResetVideoElement() {
      // Vide compl√®tement l'√©l√©ment vid√©o pour purger buffers & attaches
      try { video.pause(); } catch {}
      video.removeAttribute('src');
      // Retire aussi l‚Äôattribut srcObject au cas o√π (pas utilis√© ici mais safe)
      try { video.srcObject = null; } catch {}
      video.load(); // force un reset interne du tag <video>
    }

    function destroyHls() {
      if (hls) {
        try { hls.destroy(); } catch {}
        hls = null;
      }
    }

    function initHlsAt(startTime = 0) {
      destroyHls();
      hardResetVideoElement();

      // Safari natif HLS
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        show(true);
        video.src = url;
        internalSeek = true;
        video.addEventListener('loadedmetadata', function onMeta() {
          video.removeEventListener('loadedmetadata', onMeta);
          video.currentTime = startTime;
          video.play().catch(()=>{});
          show(false);
          state = 'IDLE';
        });
        return;
      }

      // Hls.js (Chrome/Edge/Firefox)
      hls = new Hls({
        lowLatencyMode: false,     // VOD
        startPosition: startTime,  // d√©marre directement √† la position demand√©e
        maxBufferLength: 6,
        maxMaxBufferLength: 12,
        backBufferLength: 0,
        enableWorker: true
      });

      state = 'RELOADING';
      show(true);

      hls.on(Hls.Events.ERROR, (_e, data) => {
        console.error('HLS error', data);
        // on √©vite les loops : on repasse en IDLE m√™me en cas d‚Äôerreur r√©seau
        state = 'IDLE';
        show(false);
      });

      hls.attachMedia(video);

      hls.on(Hls.Events.MEDIA_ATTACHED, () => {
        hls.loadSource(url);
      });

      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        // on force la position pour √™tre s√ªr (certains manifests ignorent startPosition)
        internalSeek = true;
        video.currentTime = startTime;
        video.play().catch(()=>{});
      });

      // D√®s qu‚Äôun fragment est effectivement bufferis√©, on consid√®re le reload termin√©
      hls.on(Hls.Events.FRAG_BUFFERED, () => {
        show(false);
        state = 'IDLE';
      });

      lastStartPos = startTime;
    }

    // Lancement initial
    initHlsAt(0);

    // === RELOAD TOTAL √Ä CHAQUE SEEK UTILISATEUR ===
    video.addEventListener('seeked', () => {
      // Ignore notre propre seek (quand on replace la t√™te apr√®s parse)
      if (internalSeek) { internalSeek = false; return; }

      // Anti-spam : max 1 reload / 600ms
      const now = Date.now();
      if (now - lastReloadTs < 600) return;
      lastReloadTs = now;

      // si d√©j√† en rechargement, on ne relance pas
      if (state === 'RELOADING') return;

      const pos = Math.max(0, Math.floor(video.currentTime)); // seconde enti√®re
      if (Math.abs(pos - lastStartPos) < 0.3) return;         // pas de reload si ~m√™me place

      initHlsAt(pos); // üî• d√©truit tout, refait l‚Äôappel .m3u8, repart √† la bonne seconde
    });
  </script>
</body>
</html>
